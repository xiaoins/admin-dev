# 用户管理模块 API 测试指南

## 📋 模块概述

用户管理模块提供了完整的用户CRUD操作，包括：
- ✅ 分页查询用户列表
- ✅ 查询用户详情
- ✅ 创建用户
- ✅ 更新用户信息
- ✅ 删除用户
- ✅ 启用/禁用用户
- ✅ 重置用户密码

---

## 🚀 开始测试

### 前置条件

1. **后端已启动**
   ```bash
   cd admin
   mvn spring-boot:run
   ```

2. **获取访问令牌**

访问：http://localhost:8080/api/admin/v1/doc.html

先调用 **认证模块 → 用户登录** 获取 Token：

**请求：**
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "tokenType": "Bearer",
    "expiresIn": 604800
  }
}
```

3. **设置 Authorization Header**

在后续所有请求中，需要在请求头添加：
```
Authorization: Bearer {token}
```

---

## 📝 API 测试用例

### 1. 分页查询用户列表

**接口：** `GET /api/admin/v1/users/page`

**请求参数：**
```
username=（可选）用户名，模糊查询
realName=（可选）真实姓名，模糊查询
phone=（可选）手机号
roleId=（可选）角色ID
status=（可选）状态（0禁用 1启用）
pageNum=1（当前页码）
pageSize=10（每页大小）
```

**测试用例 1.1：查询所有用户**
```
GET /api/admin/v1/users/page?pageNum=1&pageSize=10
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "records": [
      {
        "userId": 1,
        "username": "admin",
        "realName": "系统管理员",
        "phone": "13800138000",
        "email": "admin@example.com",
        "roleId": 1,
        "roleName": "超级管理员",
        "status": 1,
        "statusDesc": "启用",
        "createTime": "2025-10-05 16:42:17",
        "updateTime": "2025-10-05 16:44:46"
      }
    ],
    "total": 3,
    "size": 10,
    "current": 1
  }
}
```

**测试用例 1.2：按用户名模糊查询**
```
GET /api/admin/v1/users/page?username=admin&pageNum=1&pageSize=10
```

**测试用例 1.3：按角色查询**
```
GET /api/admin/v1/users/page?roleId=1&pageNum=1&pageSize=10
```

**测试用例 1.4：查询禁用的用户**
```
GET /api/admin/v1/users/page?status=0&pageNum=1&pageSize=10
```

---

### 2. 查询用户详情

**接口：** `GET /api/admin/v1/users/{userId}`

**测试用例 2.1：查询admin用户详情**
```
GET /api/admin/v1/users/1
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "realName": "系统管理员",
    "phone": "13800138000",
    "email": "admin@example.com",
    "roleId": 1,
    "roleName": "超级管理员",
    "status": 1,
    "statusDesc": "启用",
    "createTime": "2025-10-05 16:42:17",
    "updateTime": "2025-10-05 16:44:46"
  }
}
```

**测试用例 2.2：查询不存在的用户**
```
GET /api/admin/v1/users/999
```

**预期响应：**
```json
{
  "code": "A0004",
  "message": "数据不存在"
}
```

---

### 3. 创建用户

**接口：** `POST /api/admin/v1/users`

**测试用例 3.1：创建正常用户**

**请求体：**
```json
{
  "username": "test001",
  "password": "123456",
  "realName": "测试用户001",
  "phone": "13900139001",
  "email": "test001@example.com",
  "roleId": 2,
  "status": 1
}
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": 4
}
```

**测试用例 3.2：创建重复用户名**

**请求体：**
```json
{
  "username": "admin",
  "password": "123456",
  "realName": "测试",
  "phone": "13900139002",
  "email": "test@example.com",
  "roleId": 2,
  "status": 1
}
```

**预期响应：**
```json
{
  "code": "A0001",
  "message": "用户名已存在"
}
```

**测试用例 3.3：创建时手机号重复**

**请求体：**
```json
{
  "username": "test002",
  "password": "123456",
  "realName": "测试",
  "phone": "13800138000",
  "email": "test002@example.com",
  "roleId": 2,
  "status": 1
}
```

**预期响应：**
```json
{
  "code": "A0001",
  "message": "手机号已被使用"
}
```

**测试用例 3.4：参数校验-用户名格式错误**

**请求体：**
```json
{
  "username": "ab",
  "password": "123456",
  "realName": "测试",
  "roleId": 2
}
```

**预期响应：**
```json
{
  "code": "A0002",
  "message": "用户名必须是4-20位字母、数字或下划线"
}
```

**测试用例 3.5：参数校验-密码太短**

**请求体：**
```json
{
  "username": "test003",
  "password": "123",
  "realName": "测试",
  "roleId": 2
}
```

**预期响应：**
```json
{
  "code": "A0002",
  "message": "密码长度必须在6-20位之间"
}
```

---

### 4. 更新用户

**接口：** `PUT /api/admin/v1/users`

**测试用例 4.1：更新用户信息**

**请求体：**
```json
{
  "userId": 4,
  "realName": "测试用户001（已修改）",
  "phone": "13900139009",
  "email": "test001_new@example.com",
  "roleId": 3,
  "status": 1
}
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

**测试用例 4.2：更新不存在的用户**

**请求体：**
```json
{
  "userId": 999,
  "realName": "测试",
  "roleId": 2,
  "status": 1
}
```

**预期响应：**
```json
{
  "code": "A0004",
  "message": "数据不存在"
}
```

---

### 5. 删除用户

**接口：** `DELETE /api/admin/v1/users/{userId}`

**测试用例 5.1：删除普通用户**
```
DELETE /api/admin/v1/users/4
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

**测试用例 5.2：删除admin用户（应该被拒绝）**
```
DELETE /api/admin/v1/users/1
```

**预期响应：**
```json
{
  "code": "A0001",
  "message": "不能删除系统管理员"
}
```

**测试用例 5.3：删除不存在的用户**
```
DELETE /api/admin/v1/users/999
```

**预期响应：**
```json
{
  "code": "A0004",
  "message": "数据不存在"
}
```

---

### 6. 启用/禁用用户

**接口：** `PUT /api/admin/v1/users/{userId}/status/{status}`

**测试用例 6.1：禁用用户**
```
PUT /api/admin/v1/users/2/status/0
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

**测试用例 6.2：启用用户**
```
PUT /api/admin/v1/users/2/status/1
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

**测试用例 6.3：禁用admin用户（应该被拒绝）**
```
PUT /api/admin/v1/users/1/status/0
```

**预期响应：**
```json
{
  "code": "A0001",
  "message": "不能禁用系统管理员"
}
```

---

### 7. 重置用户密码

**接口：** `PUT /api/admin/v1/users/reset-password`

**测试用例 7.1：重置密码**

**请求体：**
```json
{
  "userId": 2,
  "newPassword": "newpass123"
}
```

**预期响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true
}
```

**验证：** 退出登录后，使用新密码 `newpass123` 登录 `operator` 用户，应该成功。

**测试用例 7.2：重置不存在用户的密码**

**请求体：**
```json
{
  "userId": 999,
  "newPassword": "123456"
}
```

**预期响应：**
```json
{
  "code": "A0004",
  "message": "数据不存在"
}
```

**测试用例 7.3：密码格式校验**

**请求体：**
```json
{
  "userId": 2,
  "newPassword": "123"
}
```

**预期响应：**
```json
{
  "code": "A0002",
  "message": "密码长度必须在6-20位之间"
}
```

---

## 🧪 完整测试流程

### 步骤 1：登录获取Token
```
POST /api/admin/v1/auth/login
{
  "username": "admin",
  "password": "admin123"
}
```

### 步骤 2：查询用户列表
```
GET /api/admin/v1/users/page?pageNum=1&pageSize=10
```

### 步骤 3：创建新用户
```
POST /api/admin/v1/users
{
  "username": "testuser",
  "password": "test123",
  "realName": "测试用户",
  "phone": "13900139999",
  "email": "testuser@example.com",
  "roleId": 2,
  "status": 1
}
```

### 步骤 4：查询新用户详情
```
GET /api/admin/v1/users/{返回的userId}
```

### 步骤 5：更新用户信息
```
PUT /api/admin/v1/users
{
  "userId": {刚创建的userId},
  "realName": "测试用户（已修改）",
  "phone": "13900139999",
  "email": "testuser@example.com",
  "roleId": 3,
  "status": 1
}
```

### 步骤 6：禁用用户
```
PUT /api/admin/v1/users/{userId}/status/0
```

### 步骤 7：启用用户
```
PUT /api/admin/v1/users/{userId}/status/1
```

### 步骤 8：重置密码
```
PUT /api/admin/v1/users/reset-password
{
  "userId": {userId},
  "newPassword": "newpass123"
}
```

### 步骤 9：删除用户
```
DELETE /api/admin/v1/users/{userId}
```

### 步骤 10：验证删除成功
```
GET /api/admin/v1/users/{userId}
// 应该返回 "数据不存在"
```

---

## 🔒 权限说明

所有用户管理接口都需要：
1. **认证：** 必须携带有效的 JWT Token
2. **授权：** 需要有相应的权限（后续会实现RBAC）

当前阶段，只要是登录用户就可以访问这些接口。

---

## ⚠️ 注意事项

### 1. 系统保护
- ❌ **不能删除** admin 用户
- ❌ **不能禁用** admin 用户

### 2. 数据校验
- 用户名：4-20位字母、数字或下划线
- 密码：6-20位任意字符
- 手机号：11位中国大陆手机号
- 邮箱：标准邮箱格式

### 3. 唯一性约束
- 用户名：全局唯一
- 手机号：全局唯一（如果提供）

### 4. 密码安全
- 密码使用 BCrypt 加密存储
- 密码字段不会在查询接口中返回
- 重置密码后，旧密码立即失效

---

## 📊 数据库查询验证

如果需要在数据库中验证数据：

```sql
-- 查询所有用户
SELECT 
    user_id, username, real_name, phone, email, 
    role_id, status, create_time, update_time
FROM sys_user;

-- 查询用户及其角色
SELECT 
    u.user_id, u.username, u.real_name, u.status,
    r.role_name
FROM sys_user u
LEFT JOIN sys_role r ON u.role_id = r.role_id;

-- 检查密码长度（应该是60）
SELECT username, LENGTH(password) as pwd_length
FROM sys_user;
```

---

## 📝 测试检查清单

- [ ] 用户列表分页查询正常
- [ ] 各种筛选条件生效
- [ ] 用户详情查询正常
- [ ] 创建用户成功
- [ ] 用户名重复检测生效
- [ ] 手机号重复检测生效
- [ ] 参数校验正常工作
- [ ] 更新用户信息成功
- [ ] 删除用户成功
- [ ] 不能删除admin用户
- [ ] 启用/禁用用户成功
- [ ] 不能禁用admin用户
- [ ] 重置密码成功
- [ ] 新密码能正常登录

---

**文档创建时间：2025-10-06**  
**模块状态：✅ 开发完成，待测试**

