# å¯†ç ç™»å½•å¤±è´¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

**ç—‡çŠ¶ï¼š**
- ç”¨æˆ·ç™»å½•æ—¶æç¤º"å¯†ç é”™è¯¯" (é”™è¯¯ç : U1003)
- æ˜ç¡®çŸ¥é“å¯†ç æ˜¯æ­£ç¡®çš„ï¼ˆå¦‚ï¼šadmin123ï¼‰
- åç«¯æ—¥å¿—æ˜¾ç¤º BCrypt éªŒè¯å¤±è´¥

**æ—¥å¿—ç‰¹å¾ï¼š**
```
å¯†ç å“ˆå¸Œé•¿åº¦: 62
Encoded password does not look like BCrypt
å¯†ç éªŒè¯ç»“æœ: false
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### æ ¸å¿ƒé—®é¢˜ï¼šBCrypt å“ˆå¸Œé•¿åº¦é”™è¯¯

**æ ‡å‡† BCrypt å“ˆå¸Œï¼š**
- **é•¿åº¦ï¼šå›ºå®š 60 ä¸ªå­—ç¬¦**
- **æ ¼å¼ï¼š**`$2a$[rounds]$[22å­—ç¬¦salt][31å­—ç¬¦hash]`
- **ç¤ºä¾‹ï¼š**`$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG`

**é”™è¯¯çš„å“ˆå¸Œï¼š**
- **é•¿åº¦ï¼š62 ä¸ªå­—ç¬¦**ï¼ˆå¤šäº†2ä¸ªå­—ç¬¦ï¼‰
- **å¯¼è‡´ï¼š**BCryptPasswordEncoder æ— æ³•è¯†åˆ«ï¼ŒéªŒè¯æ€»æ˜¯è¿”å› false

### æ¬¡è¦é—®é¢˜ï¼šVARCHAR å­—æ®µç±»å‹çš„å­—ç¬¦é›†é—®é¢˜

ä½¿ç”¨ `VARCHAR` å­˜å‚¨å¯†ç æ—¶ï¼ŒMySQL å¯èƒ½ä¼šï¼š
- è¿›è¡Œå­—ç¬¦é›†è½¬æ¢
- æ·»åŠ å¡«å……å­—ç¬¦
- è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ `$`ã€`.`ã€`-`ï¼‰

---

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„

**å°† password å­—æ®µä» VARCHAR æ”¹ä¸º VARBINARY**

ä¿®æ”¹æ–‡ä»¶ï¼š`admin/src/main/resources/db/migration/V1__init_schema.sql`

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE `sys_user` (
    `user_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
    `username` VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å',
    `password` VARBINARY(100) NOT NULL COMMENT 'å¯†ç ï¼ˆåŠ å¯†ï¼Œä½¿ç”¨VARBINARYé¿å…å­—ç¬¦é›†é—®é¢˜ï¼‰',  -- æ”¹è¿™é‡Œ
    `real_name` VARCHAR(50) DEFAULT NULL COMMENT 'çœŸå®å§“å',
    `phone` VARCHAR(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
    `email` VARCHAR(50) DEFAULT NULL COMMENT 'é‚®ç®±',
    `role_id` BIGINT DEFAULT NULL COMMENT 'è§’è‰²ID',
    `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼ˆ0ç¦ç”¨ 1å¯ç”¨ï¼‰',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`user_id`),
    UNIQUE KEY `uk_username` (`username`),
    KEY `idx_role_id` (`role_id`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ VARBINARYï¼š**
- âœ… å­˜å‚¨çº¯äºŒè¿›åˆ¶æ•°æ®ï¼Œä¸è¿›è¡Œå­—ç¬¦é›†è½¬æ¢
- âœ… ä¸ä¼šæ·»åŠ é¢å¤–çš„å¡«å……å­—ç¬¦
- âœ… ä¿è¯å­˜å‚¨çš„å­—èŠ‚æ•°ä¸è¾“å…¥å®Œå…¨ä¸€è‡´

---

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå¯†ç å“ˆå¸Œç”Ÿæˆå·¥å…·

**åˆ›å»ºæµ‹è¯•ç±»ï¼š**`admin/src/test/java/com/xiaoins/admin/PasswordHashGenerator.java`

```java
package com.xiaoins.admin;

import org.junit.jupiter.api.Test;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

public class PasswordHashGenerator {
    
    @Test
    public void generatePasswordHash() {
        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
        String password = "admin123";
        String hash = encoder.encode(password);
        
        System.out.println("==================================================");
        System.out.println("ç”Ÿæˆçš„BCryptå“ˆå¸Œ:");
        System.out.println(hash);
        System.out.println("å“ˆå¸Œé•¿åº¦: " + hash.length());
        System.out.println("==================================================");
        System.out.println("\nSQLæ›´æ–°è¯­å¥:");
        System.out.println("UPDATE sys_user SET password = '" + hash + "' WHERE username IN ('admin', 'operator', 'analyst');");
        System.out.println("==================================================");
        
        // éªŒè¯
        boolean matches = encoder.matches(password, hash);
        System.out.println("\néªŒè¯ç»“æœ: " + (matches ? "âœ“ æˆåŠŸ" : "âœ— å¤±è´¥"));
    }
}
```

**è¿è¡Œç”Ÿæˆå“ˆå¸Œï¼š**
```bash
cd admin
mvn test -Dtest=PasswordHashGenerator#generatePasswordHash
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
==================================================
ç”Ÿæˆçš„BCryptå“ˆå¸Œ:
$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG
å“ˆå¸Œé•¿åº¦: 60
==================================================

SQLæ›´æ–°è¯­å¥:
UPDATE sys_user SET password = '$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG' WHERE username IN ('admin', 'operator', 'analyst');
==================================================

éªŒè¯ç»“æœ: âœ“ æˆåŠŸ
```

---

### ç¬¬ä¸‰æ­¥ï¼šé‡å»ºæ•°æ®åº“å¹¶æ›´æ–°å¯†ç 

#### æ–¹æ¡ˆAï¼šå®Œå…¨é‡å»ºæ•°æ®åº“ï¼ˆæ¨èï¼‰

```bash
# 1. åˆ é™¤æ—§æ•°æ®åº“
mysql -u root -p -e "DROP DATABASE IF EXISTS mall_admin;"

# 2. åˆ›å»ºæ–°æ•°æ®åº“
mysql -u root -p -e "CREATE DATABASE mall_admin CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 3. é‡å¯åç«¯ï¼ŒFlyway ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»è„šæœ¬
cd admin
mvn spring-boot:run
```

**ç„¶åæ‰§è¡Œç¬¬å››æ­¥ç”Ÿæˆæ–°å¯†ç å¹¶æ›´æ–°ã€‚**

---

#### æ–¹æ¡ˆBï¼šç›´æ¥ä¿®æ”¹ç°æœ‰è¡¨ï¼ˆå¿«é€Ÿä¿®å¤ï¼‰

```sql
-- 1. è¿æ¥æ•°æ®åº“
USE mall_admin;

-- 2. ä¿®æ”¹è¡¨ç»“æ„
ALTER TABLE sys_user 
MODIFY COLUMN password VARBINARY(100) NOT NULL COMMENT 'å¯†ç ï¼ˆåŠ å¯†ï¼Œä½¿ç”¨VARBINARYé¿å…å­—ç¬¦é›†é—®é¢˜ï¼‰';

-- 3. ä½¿ç”¨ç”Ÿæˆçš„å“ˆå¸Œæ›´æ–°å¯†ç ï¼ˆä»ç¬¬äºŒæ­¥è·å–ï¼‰
UPDATE sys_user 
SET password = '$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG' 
WHERE username IN ('admin', 'operator', 'analyst');

-- 4. éªŒè¯å¯†ç é•¿åº¦
SELECT username, LENGTH(password) as pwd_length 
FROM sys_user 
WHERE username = 'admin';
-- åº”è¯¥æ˜¾ç¤ºï¼špwd_length = 60
```

---

### ç¬¬å››æ­¥ï¼šéªŒè¯ä¿®å¤ç»“æœ

#### 1. æ£€æŸ¥è¡¨ç»“æ„
```sql
SHOW CREATE TABLE sys_user;
```

**ç¡®è®¤ password å­—æ®µæ˜¯ï¼š**`varbinary(100)`

#### 2. æ£€æŸ¥å¯†ç é•¿åº¦
```sql
SELECT 
    username,
    LENGTH(password) as pwd_length,
    CAST(password AS CHAR) as pwd_preview
FROM sys_user 
WHERE username = 'admin';
```

**é¢„æœŸç»“æœï¼š**
- `pwd_length`: **60** âœ…
- `pwd_preview`: ä»¥ `$2a$10$` å¼€å¤´

#### 3. æµ‹è¯•ç™»å½•

è®¿é—®ï¼š`http://localhost:8080/api/admin/v1/doc.html`

**ç™»å½•è¯·æ±‚ï¼š**
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "tokenType": "Bearer",
    "expiresIn": 604800,
    "userInfo": {
      "userId": 1,
      "username": "admin",
      "realName": "ç³»ç»Ÿç®¡ç†å‘˜",
      "roleId": 1
    }
  }
}
```

---

## ğŸ› ï¸ é—®é¢˜æ’æŸ¥æ­¥éª¤

å¦‚æœå†æ¬¡é‡åˆ°å¯†ç ç™»å½•é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š

### 1. æ£€æŸ¥å¯†ç å“ˆå¸Œé•¿åº¦
```sql
SELECT username, LENGTH(password) as pwd_length 
FROM sys_user 
WHERE username = 'admin';
```

**æ­£ç¡®å€¼ï¼š60**  
**é”™è¯¯å€¼ï¼š59, 62, æˆ–å…¶ä»–**

---

### 2. æ£€æŸ¥è¡¨å­—æ®µç±»å‹
```sql
SHOW CREATE TABLE sys_user;
```

**æ­£ç¡®ç±»å‹ï¼š**`varbinary(100)`  
**é—®é¢˜ç±»å‹ï¼š**`varchar(100)`

---

### 3. æ£€æŸ¥åç«¯æ—¥å¿—

**æŸ¥æ‰¾å…³é”®è¯ï¼š**
```
å¯†ç å“ˆå¸Œé•¿åº¦
Encoded password does not look like BCrypt
å¯†ç éªŒè¯ç»“æœ
```

**æ­£å¸¸æ—¥å¿—ï¼š**
```
å¯†ç å“ˆå¸Œé•¿åº¦: 60
å¯†ç éªŒè¯ç»“æœ: true
```

**å¼‚å¸¸æ—¥å¿—ï¼š**
```
å¯†ç å“ˆå¸Œé•¿åº¦: 62
Encoded password does not look like BCrypt
å¯†ç éªŒè¯ç»“æœ: false
```

---

### 4. éªŒè¯å“ˆå¸Œæ ¼å¼

**æ ‡å‡† BCrypt å“ˆå¸Œç‰¹å¾ï¼š**
- ä»¥ `$2a$`, `$2b$`, æˆ– `$2y$` å¼€å¤´
- æ ¼å¼ï¼š`$2a$[rounds]$[salt][hash]`
- æ€»é•¿åº¦ï¼š60 å­—ç¬¦
- ç¤ºä¾‹ï¼š`$2a$10$N9qo8uLOickgx2ZMRZoMyeIcVFN8f7Lv4TS9C9.mGMKMFmKJKKEW`

---

## ğŸ“š ç›¸å…³çŸ¥è¯†ç‚¹

### BCrypt å“ˆå¸Œç»“æ„

```
$2a$10$N9qo8uLOickgx2ZMRZoMye/IcVFN8f7Lv4TS9C9.mGMKMFmKJKKEW
|  | |  |                                                      |
|  | |  |                                                      â””â”€ å“ˆå¸Œå€¼ (31å­—ç¬¦)
|  | |  â””â”€ ç›å€¼ (22å­—ç¬¦)
|  | â””â”€ è®¡ç®—è½®æ¬¡ï¼ˆroundsï¼Œ10è¡¨ç¤º2^10æ¬¡ï¼‰
|  â””â”€ ç‰ˆæœ¬æ ‡è¯†ç¬¦
â””â”€ ç®—æ³•æ ‡è¯†ç¬¦
```

**æ€»é•¿åº¦è®¡ç®—ï¼š**
- `$` (1) + `2a` (2) + `$` (1) + `10` (2) + `$` (1) + ç›å€¼ (22) + å“ˆå¸Œå€¼ (31) = **60 å­—ç¬¦**

---

### VARCHAR vs VARBINARY

| ç‰¹æ€§ | VARCHAR | VARBINARY |
|------|---------|-----------|
| å­˜å‚¨ç±»å‹ | å­—ç¬¦ä¸² | äºŒè¿›åˆ¶æ•°æ® |
| å­—ç¬¦é›†å¤„ç† | âœ… æ˜¯ | âŒ å¦ |
| å­—ç¬¦é›†è½¬æ¢ | âœ… å¯èƒ½å‘ç”Ÿ | âŒ ä¸ä¼š |
| å¡«å……å­—ç¬¦ | âœ… å¯èƒ½æ·»åŠ  | âŒ ä¸ä¼š |
| ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ | âœ… å¯èƒ½å‘ç”Ÿ | âŒ ä¸ä¼š |
| é€‚ç”¨åœºæ™¯ | æ–‡æœ¬æ•°æ® | åŠ å¯†æ•°æ®ã€äºŒè¿›åˆ¶ |

**ç»“è®ºï¼šå¯†ç ç­‰åŠ å¯†æ•°æ®åº”ä½¿ç”¨ VARBINARY**

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸è¦ç›´æ¥å¤åˆ¶å“ˆå¸Œå€¼
- âŒ ä»ç½‘ä¸Šå¤åˆ¶ BCrypt ç¤ºä¾‹å“ˆå¸Œ
- âŒ ä»å…¶ä»–é¡¹ç›®å¤åˆ¶å“ˆå¸Œå€¼
- âœ… ä½¿ç”¨ `BCryptPasswordEncoder` ç”Ÿæˆ

### 2. æ¯æ¬¡ç”Ÿæˆçš„å“ˆå¸Œéƒ½ä¸åŒ
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
String hash1 = encoder.encode("admin123");
String hash2 = encoder.encode("admin123");

// hash1 != hash2 ï¼ˆå› ä¸ºç›å€¼éšæœºï¼‰
// ä½†æ˜¯ä¸¤ä¸ªéƒ½èƒ½éªŒè¯æˆåŠŸï¼š
encoder.matches("admin123", hash1); // true
encoder.matches("admin123", hash2); // true
```

### 3. æ•°æ®åº“è¿ç§»è„šæœ¬ä¿®æ”¹åéœ€è¦é‡å»º
å¦‚æœä¿®æ”¹äº† Flyway è¿ç§»è„šæœ¬ï¼ˆV1ã€V2ç­‰ï¼‰ï¼Œå¿…é¡»ï¼š
1. åˆ é™¤æ•°æ®åº“
2. é‡æ–°åˆ›å»ºæ•°æ®åº“
3. é‡å¯åº”ç”¨è®© Flyway é‡æ–°æ‰§è¡Œ

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **è¡¨ç»“æ„å®šä¹‰ï¼š**`admin/src/main/resources/db/migration/V1__init_schema.sql`
- **åˆå§‹æ•°æ®ï¼š**`admin/src/main/resources/db/migration/V2__seed_basic_data.sql`
- **å¯†ç ç”Ÿæˆå·¥å…·ï¼š**`admin/src/test/java/com/xiaoins/admin/PasswordHashGenerator.java`
- **è®¤è¯æœåŠ¡ï¼š**`admin/src/main/java/com/xiaoins/admin/auth/service/AuthService.java`

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åˆ›å»ºæ–°ç”¨æˆ·æ—¶
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
String rawPassword = "userPassword";
String encodedPassword = encoder.encode(rawPassword);

// å­˜å…¥æ•°æ®åº“
user.setPassword(encodedPassword);
userMapper.insert(user);
```

### 2. é‡ç½®å¯†ç æ—¶
```sql
-- 1. ç”Ÿæˆæ–°å“ˆå¸Œï¼ˆä½¿ç”¨ Java å·¥å…·ç±»ï¼‰
mvn test -Dtest=PasswordHashGenerator#generatePasswordHash

-- 2. æ›´æ–°æ•°æ®åº“
UPDATE sys_user 
SET password = '[ç”Ÿæˆçš„60å­—ç¬¦å“ˆå¸Œ]' 
WHERE username = 'xxx';
```

### 3. éªŒè¯å¯†ç æ—¶
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
boolean matches = encoder.matches(rawPassword, encodedPassword);
if (matches) {
    // å¯†ç æ­£ç¡®
} else {
    // å¯†ç é”™è¯¯
}
```

---

## ğŸ“ é—®é¢˜è”ç³»

å¦‚æœæŒ‰ç…§æ­¤æ–‡æ¡£æ“ä½œåä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. MySQL ç‰ˆæœ¬ï¼ˆæ¨è 8.0+ï¼‰
2. Spring Security ç‰ˆæœ¬ï¼ˆæ¨è 6.xï¼‰
3. Java ç‰ˆæœ¬ï¼ˆæ¨è 17+ï¼‰
4. æ•°æ®åº“å­—ç¬¦é›†ï¼š`utf8mb4`
5. æ•°æ®åº“æ’åºè§„åˆ™ï¼š`utf8mb4_unicode_ci`

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2025-10-06**  
**æœ€åæ›´æ–°æ—¶é—´ï¼š2025-10-06**  
**é—®é¢˜è§£å†³ç”¨æ—¶ï¼šçº¦1å°æ—¶**  
**æœ€ç»ˆçŠ¶æ€ï¼šâœ… å·²è§£å†³**

