# 密码登录失败问题解决方案

## 📋 问题描述

**症状：**
- 用户登录时提示"密码错误" (错误码: U1003)
- 明确知道密码是正确的（如：admin123）
- 后端日志显示 BCrypt 验证失败

**日志特征：**
```
密码哈希长度: 62
Encoded password does not look like BCrypt
密码验证结果: false
```

---

## 🔍 根本原因

### 核心问题：BCrypt 哈希长度错误

**标准 BCrypt 哈希：**
- **长度：固定 60 个字符**
- **格式：**`$2a$[rounds]$[22字符salt][31字符hash]`
- **示例：**`$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG`

**错误的哈希：**
- **长度：62 个字符**（多了2个字符）
- **导致：**BCryptPasswordEncoder 无法识别，验证总是返回 false

### 次要问题：VARCHAR 字段类型的字符集问题

使用 `VARCHAR` 存储密码时，MySQL 可能会：
- 进行字符集转换
- 添加填充字符
- 转义特殊字符（如 `$`、`.`、`-`）

---

## ✅ 完整解决方案

### 第一步：修改数据库表结构

**将 password 字段从 VARCHAR 改为 VARBINARY**

修改文件：`admin/src/main/resources/db/migration/V1__init_schema.sql`

```sql
-- 用户表
CREATE TABLE `sys_user` (
    `user_id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
    `username` VARCHAR(50) NOT NULL COMMENT '用户名',
    `password` VARBINARY(100) NOT NULL COMMENT '密码（加密，使用VARBINARY避免字符集问题）',  -- 改这里
    `real_name` VARCHAR(50) DEFAULT NULL COMMENT '真实姓名',
    `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
    `email` VARCHAR(50) DEFAULT NULL COMMENT '邮箱',
    `role_id` BIGINT DEFAULT NULL COMMENT '角色ID',
    `status` TINYINT DEFAULT 1 COMMENT '状态（0禁用 1启用）',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`user_id`),
    UNIQUE KEY `uk_username` (`username`),
    KEY `idx_role_id` (`role_id`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**为什么使用 VARBINARY：**
- ✅ 存储纯二进制数据，不进行字符集转换
- ✅ 不会添加额外的填充字符
- ✅ 保证存储的字节数与输入完全一致

---

### 第二步：创建密码哈希生成工具

**创建测试类：**`admin/src/test/java/com/xiaoins/admin/PasswordHashGenerator.java`

```java
package com.xiaoins.admin;

import org.junit.jupiter.api.Test;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

public class PasswordHashGenerator {
    
    @Test
    public void generatePasswordHash() {
        BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
        String password = "admin123";
        String hash = encoder.encode(password);
        
        System.out.println("==================================================");
        System.out.println("生成的BCrypt哈希:");
        System.out.println(hash);
        System.out.println("哈希长度: " + hash.length());
        System.out.println("==================================================");
        System.out.println("\nSQL更新语句:");
        System.out.println("UPDATE sys_user SET password = '" + hash + "' WHERE username IN ('admin', 'operator', 'analyst');");
        System.out.println("==================================================");
        
        // 验证
        boolean matches = encoder.matches(password, hash);
        System.out.println("\n验证结果: " + (matches ? "✓ 成功" : "✗ 失败"));
    }
}
```

**运行生成哈希：**
```bash
cd admin
mvn test -Dtest=PasswordHashGenerator#generatePasswordHash
```

**输出示例：**
```
==================================================
生成的BCrypt哈希:
$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG
哈希长度: 60
==================================================

SQL更新语句:
UPDATE sys_user SET password = '$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG' WHERE username IN ('admin', 'operator', 'analyst');
==================================================

验证结果: ✓ 成功
```

---

### 第三步：重建数据库并更新密码

#### 方案A：完全重建数据库（推荐）

```bash
# 1. 删除旧数据库
mysql -u root -p -e "DROP DATABASE IF EXISTS mall_admin;"

# 2. 创建新数据库
mysql -u root -p -e "CREATE DATABASE mall_admin CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 3. 重启后端，Flyway 会自动执行迁移脚本
cd admin
mvn spring-boot:run
```

**然后执行第四步生成新密码并更新。**

---

#### 方案B：直接修改现有表（快速修复）

```sql
-- 1. 连接数据库
USE mall_admin;

-- 2. 修改表结构
ALTER TABLE sys_user 
MODIFY COLUMN password VARBINARY(100) NOT NULL COMMENT '密码（加密，使用VARBINARY避免字符集问题）';

-- 3. 使用生成的哈希更新密码（从第二步获取）
UPDATE sys_user 
SET password = '$2a$10$Yr/46918xCbdSF4.Lx79ieiduUHurXUzfCc0fFwx5lEGFi3gPl3TG' 
WHERE username IN ('admin', 'operator', 'analyst');

-- 4. 验证密码长度
SELECT username, LENGTH(password) as pwd_length 
FROM sys_user 
WHERE username = 'admin';
-- 应该显示：pwd_length = 60
```

---

### 第四步：验证修复结果

#### 1. 检查表结构
```sql
SHOW CREATE TABLE sys_user;
```

**确认 password 字段是：**`varbinary(100)`

#### 2. 检查密码长度
```sql
SELECT 
    username,
    LENGTH(password) as pwd_length,
    CAST(password AS CHAR) as pwd_preview
FROM sys_user 
WHERE username = 'admin';
```

**预期结果：**
- `pwd_length`: **60** ✅
- `pwd_preview`: 以 `$2a$10$` 开头

#### 3. 测试登录

访问：`http://localhost:8080/api/admin/v1/doc.html`

**登录请求：**
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**成功响应：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "tokenType": "Bearer",
    "expiresIn": 604800,
    "userInfo": {
      "userId": 1,
      "username": "admin",
      "realName": "系统管理员",
      "roleId": 1
    }
  }
}
```

---

## 🛠️ 问题排查步骤

如果再次遇到密码登录问题，按以下步骤排查：

### 1. 检查密码哈希长度
```sql
SELECT username, LENGTH(password) as pwd_length 
FROM sys_user 
WHERE username = 'admin';
```

**正确值：60**  
**错误值：59, 62, 或其他**

---

### 2. 检查表字段类型
```sql
SHOW CREATE TABLE sys_user;
```

**正确类型：**`varbinary(100)`  
**问题类型：**`varchar(100)`

---

### 3. 检查后端日志

**查找关键词：**
```
密码哈希长度
Encoded password does not look like BCrypt
密码验证结果
```

**正常日志：**
```
密码哈希长度: 60
密码验证结果: true
```

**异常日志：**
```
密码哈希长度: 62
Encoded password does not look like BCrypt
密码验证结果: false
```

---

### 4. 验证哈希格式

**标准 BCrypt 哈希特征：**
- 以 `$2a$`, `$2b$`, 或 `$2y$` 开头
- 格式：`$2a$[rounds]$[salt][hash]`
- 总长度：60 字符
- 示例：`$2a$10$N9qo8uLOickgx2ZMRZoMyeIcVFN8f7Lv4TS9C9.mGMKMFmKJKKEW`

---

## 📚 相关知识点

### BCrypt 哈希结构

```
$2a$10$N9qo8uLOickgx2ZMRZoMye/IcVFN8f7Lv4TS9C9.mGMKMFmKJKKEW
|  | |  |                                                      |
|  | |  |                                                      └─ 哈希值 (31字符)
|  | |  └─ 盐值 (22字符)
|  | └─ 计算轮次（rounds，10表示2^10次）
|  └─ 版本标识符
└─ 算法标识符
```

**总长度计算：**
- `$` (1) + `2a` (2) + `$` (1) + `10` (2) + `$` (1) + 盐值 (22) + 哈希值 (31) = **60 字符**

---

### VARCHAR vs VARBINARY

| 特性 | VARCHAR | VARBINARY |
|------|---------|-----------|
| 存储类型 | 字符串 | 二进制数据 |
| 字符集处理 | ✅ 是 | ❌ 否 |
| 字符集转换 | ✅ 可能发生 | ❌ 不会 |
| 填充字符 | ✅ 可能添加 | ❌ 不会 |
| 特殊字符转义 | ✅ 可能发生 | ❌ 不会 |
| 适用场景 | 文本数据 | 加密数据、二进制 |

**结论：密码等加密数据应使用 VARBINARY**

---

## ⚠️ 注意事项

### 1. 不要直接复制哈希值
- ❌ 从网上复制 BCrypt 示例哈希
- ❌ 从其他项目复制哈希值
- ✅ 使用 `BCryptPasswordEncoder` 生成

### 2. 每次生成的哈希都不同
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
String hash1 = encoder.encode("admin123");
String hash2 = encoder.encode("admin123");

// hash1 != hash2 （因为盐值随机）
// 但是两个都能验证成功：
encoder.matches("admin123", hash1); // true
encoder.matches("admin123", hash2); // true
```

### 3. 数据库迁移脚本修改后需要重建
如果修改了 Flyway 迁移脚本（V1、V2等），必须：
1. 删除数据库
2. 重新创建数据库
3. 重启应用让 Flyway 重新执行

---

## 🔗 相关文件

- **表结构定义：**`admin/src/main/resources/db/migration/V1__init_schema.sql`
- **初始数据：**`admin/src/main/resources/db/migration/V2__seed_basic_data.sql`
- **密码生成工具：**`admin/src/test/java/com/xiaoins/admin/PasswordHashGenerator.java`
- **认证服务：**`admin/src/main/java/com/xiaoins/admin/auth/service/AuthService.java`

---

## 💡 最佳实践

### 1. 创建新用户时
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
String rawPassword = "userPassword";
String encodedPassword = encoder.encode(rawPassword);

// 存入数据库
user.setPassword(encodedPassword);
userMapper.insert(user);
```

### 2. 重置密码时
```sql
-- 1. 生成新哈希（使用 Java 工具类）
mvn test -Dtest=PasswordHashGenerator#generatePasswordHash

-- 2. 更新数据库
UPDATE sys_user 
SET password = '[生成的60字符哈希]' 
WHERE username = 'xxx';
```

### 3. 验证密码时
```java
BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
boolean matches = encoder.matches(rawPassword, encodedPassword);
if (matches) {
    // 密码正确
} else {
    // 密码错误
}
```

---

## 📞 问题联系

如果按照此文档操作后仍有问题，请检查：
1. MySQL 版本（推荐 8.0+）
2. Spring Security 版本（推荐 6.x）
3. Java 版本（推荐 17+）
4. 数据库字符集：`utf8mb4`
5. 数据库排序规则：`utf8mb4_unicode_ci`

---

**文档创建时间：2025-10-06**  
**最后更新时间：2025-10-06**  
**问题解决用时：约1小时**  
**最终状态：✅ 已解决**

